{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule - ASSIST</title>
    <link rel="stylesheet" href="{% static 'hello/css/section.css' %}">
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="page-title">SCHEDULE</div>
        <div class="admin-section" onclick="toggleDropdown()">
            <div class="admin-avatar"></div>
            <span class="admin-name">{{ faculty.first_name|default:"FACULTY" }}</span>
            <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M7 10l5 5 5-5z"/>
            </svg>
            <div class="dropdown-menu" id="dropdownMenu">
                <a href="{% url 'admin_logout' %}">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Sidebar Navigation (staff only: Dashboard & Schedule) -->
    <aside class="sidebar">
        <a href="{% url 'staff_dashboard' %}" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M4 13h6c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1zm0 8h6c.55 0 1-.45 1-1v-4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1zm10 0h6c.55 0 1-.45 1-1v-8c0-.55-.45-1-1-1h-6c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1zM13 4v4c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1h-6c-.55 0-1 .45-1 1z"/>
            </svg>
            <span>Dashboard</span>
        </a>
        <a href="{% url 'staff_schedule' %}" class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
            </svg>
            <span>Schedule</span>
        </a>
    </aside>

    <!-- Main Content: Only right-side schedule panel for staff -->
    <main class="main-content">
        <div class="right-panel" id="schedulePanel">
            <div class="schedule-header">
                <div class="schedule-title-section">
                    <h2 id="scheduleTitle">My Schedule</h2>
                    <p id="scheduleSubtitle">All assigned courses and sessions</p>
                </div>
                <div class="schedule-actions">
                    <button class="btn-export" onclick="exportSchedule()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18">
                            <path fill="currentColor" d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/>
                        </svg>
                        PDF
                    </button>
                    <button class="btn-print" onclick="printSchedule()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18">
                            <path fill="currentColor" d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                        </svg>
                        PRINT
                    </button>
                </div>
            </div>
            <div class="schedule-content">
                <div class="schedule-grid-wrapper">
                    <div class="schedule-grid">
                        <!-- Header Row -->
                        <div class="schedule-header-row">
                            <div class="schedule-header-cell"></div>
                            <div class="schedule-header-cell">MONDAY</div>
                            <div class="schedule-header-cell">TUESDAY</div>
                            <div class="schedule-header-cell">WEDNESDAY</div>
                            <div class="schedule-header-cell">THURSDAY</div>
                            <div class="schedule-header-cell">FRIDAY</div>
                            <div class="schedule-header-cell">SATURDAY</div>
                        </div>
                        
                        <!-- Time Column -->
                        <div class="schedule-time-column" id="timeColumn">
                            <div class="time-label" style="top: 60px;">07:30</div>
                            <div class="time-label" style="top: 120px;">08:00</div>
                            <div class="time-label" style="top: 180px;">08:30</div>
                            <div class="time-label" style="top: 240px;">09:00</div>
                            <div class="time-label" style="top: 300px;">09:30</div>
                            <div class="time-label" style="top: 360px;">10:00</div>
                            <div class="time-label" style="top: 420px;">10:30</div>
                            <div class="time-label" style="top: 480px;">11:00</div>
                            <div class="time-label" style="top: 540px;">11:30</div>
                            <div class="time-label" style="top: 600px;">12:00</div>
                            <div class="time-label" style="top: 660px;">12:30</div>
                            <div class="time-label" style="top: 720px;">13:00</div>
                            <div class="time-label" style="top: 780px;">13:30</div>
                            <div class="time-label" style="top: 840px;">14:00</div>
                            <div class="time-label" style="top: 900px;">14:30</div>
                            <div class="time-label" style="top: 960px;">15:00</div>
                            <div class="time-label" style="top: 1020px;">15:30</div>
                            <div class="time-label" style="top: 1080px;">16:00</div>
                            <div class="time-label" style="top: 1140px;">16:30</div>
                            <div class="time-label" style="top: 1200px;">17:00</div>
                            <div class="time-label" style="top: 1260px;">17:30</div>
                            <div class="time-label" style="top: 1320px;">18:00</div>
                            <div class="time-label" style="top: 1380px;">18:30</div>
                            <div class="time-label" style="top: 1440px;">19:00</div>
                            <div class="time-label" style="top: 1500px;">19:30</div>
                            <div class="time-label" style="top: 1560px;">20:00</div>
                            <div class="time-label" style="top: 1620px;">20:30</div>
                            <div class="time-label" style="top: 1680px;">21:00</div>
                            <div class="time-label" style="top: 1740px;">21:30</div>
                        </div>

                        <!-- Day Columns -->
                            <div class="schedule-day-column" data-day="0"></div>
                            <div class="schedule-day-column" data-day="1"></div>
                            <div class="schedule-day-column" data-day="2"></div>
                            <div class="schedule-day-column" data-day="3"></div>
                            <div class="schedule-day-column" data-day="4"></div>
                            <div class="schedule-day-column" data-day="5"></div>
                    </div>
                </div>
                <div class="courses-sidebar">
                    <h3>COURSES</h3>
                    <p class="sidebar-curriculum" id="sidebarCurriculum">Curriculum</p>
                    <div id="coursesList" class="courses-list">
                        <!-- Courses will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="{% static 'hello/js/schedule.js' %}"></script>
    <script>
        // Initialize staff schedule with data from view
        document.addEventListener('DOMContentLoaded', function() {
            const scheduleData = {{ schedules|safe }};
            if (scheduleData && scheduleData.length > 0) {
                renderStaffSchedule(scheduleData);
            } else {
                console.log('No schedule data available for this faculty member');
            }
        });

        // Render staff schedule with professional styling
        function renderStaffSchedule(schedules) {
            const dayColumns = document.querySelectorAll('.schedule-day-column');
            const coursesList = document.getElementById('coursesList');
            const coursesMap = new Map();  // Store unique courses with their details
            
            // Clear existing schedule blocks
            dayColumns.forEach(col => col.innerHTML = '');
            
            // Render each schedule entry
            schedules.forEach(schedule => {
                const dayColumn = dayColumns[schedule.day];
                if (!dayColumn) return;
                
                const topPos = calculateTopPosition(schedule.start_time);
                const durationMin = calculateDuration(schedule.start_time, schedule.end_time);
                const hexColor = schedule.course_color || '#FFA726';
                
                const scheduleBlock = document.createElement('div');
                scheduleBlock.className = 'schedule-block';
                scheduleBlock.style.top = `${topPos}px`;
                scheduleBlock.style.height = `${durationMin}px`;
                scheduleBlock.style.backgroundColor = hexToRGBA(hexColor, 0.25);
                scheduleBlock.style.borderLeftColor = hexColor;
                
                scheduleBlock.innerHTML = `
                    <strong class="schedule-course-code">${schedule.course_code}</strong>
                    <div class="schedule-details">${schedule.start_time} - ${schedule.end_time}</div>
                    <div class="schedule-details">${schedule.room || 'TBA'}</div>
                    <div class="schedule-details">${schedule.section_name}</div>
                `;
                dayColumn.appendChild(scheduleBlock);
                
                // Collect unique courses with their color for sidebar
                const courseKey = schedule.course_code;
                if (!coursesMap.has(courseKey)) {
                    coursesMap.set(courseKey, {
                        code: schedule.course_code,
                        title: schedule.course_title,
                        color: hexColor
                    });
                }
            });
            
            // Populate courses sidebar with professional styling
            coursesList.innerHTML = Array.from(coursesMap.values())
                .sort((a, b) => a.code.localeCompare(b.code))
                .map(course => `
                    <div class="course-item" style="border-left-color: ${course.color};">
                        <div class="course-details">
                            <div class="course-code">${course.code}</div>
                            <div class="course-title">${course.title}</div>
                        </div>
                    </div>
                `)
                .join('');
        }

        // Calculate pixel position from start time
        function calculateTopPosition(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            const totalMinutes = (hours * 60 + minutes) - (7 * 60);  // 7:30 AM = 0px
            return (totalMinutes / 30) * 60;  // Each 30 min = 60px
        }

        // Calculate duration in pixels
        function calculateDuration(startTime, endTime) {
            const [startHours, startMinutes] = startTime.split(':').map(Number);
            const [endHours, endMinutes] = endTime.split(':').map(Number);
            const startTotalMin = startHours * 60 + startMinutes;
            const endTotalMin = endHours * 60 + endMinutes;
            const durationMin = endTotalMin - startTotalMin;
            return (durationMin / 30) * 60;  // Each 30 min = 60px
        }

        // Helper function to convert hex to rgba
        function hexToRGBA(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // Dropdown toggle
        function toggleDropdown() {
            const menu = document.getElementById('dropdownMenu');
            if (menu) menu.classList.toggle('show');
        }

        // Print schedule
        function printSchedule() {
            window.location.href = "{% url 'staff_schedule_print' %}";
        }

        // Export schedule to PDF
        function exportSchedule() {
            window.location.href = "{% url 'staff_schedule_print' %}";
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.admin-section')) {
                const dropdown = document.getElementById('dropdownMenu');
                if (dropdown) dropdown.classList.remove('show');
            }
        });
    </script>