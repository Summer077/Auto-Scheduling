{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ASSIST</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'hello/css/dashboard.css' %}">
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="page-title">DASHBOARD</div>
        <div class="admin-section" onclick="toggleDropdown()">
            <span class="admin-name">ADMIN</span>
            <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M7 10l5 5 5-5z"/>
            </svg>
            <div class="dropdown-menu" id="dropdownMenu">
                <a href="{% url 'admin_logout' %}">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <a href="{% url 'admin_dashboard' %}" class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M4 13h6c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1zm0 8h6c.55 0 1-.45 1-1v-4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1zm10 0h6c.55 0 1-.45 1-1v-8c0-.55-.45-1-1-1h-6c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1zM13 4v4c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1h-6c-.55 0-1 .45-1 1z"/>
            </svg>
            <span>Dashboard</span>
        </a>
        
        <a href="{% url 'course_view' %}" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/>
            </svg>
            <span>Course</span>
        </a>
        
        <a href="#" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M16.5 12c1.38 0 2.49-1.12 2.49-2.5S17.88 7 16.5 7C15.12 7 14 8.12 14 9.5s1.12 2.5 2.5 2.5zM9 11c1.66 0 2.99-1.34 2.99-3S10.66 5 9 5C7.34 5 6 6.34 6 8s1.34 3 3 3zm7.5 3c-1.83 0-5.5.92-5.5 2.75V19h11v-2.25c0-1.83-3.67-2.75-5.5-2.75zM9 13c-2.33 0-7 1.17-7 3.5V19h7v-2.25c0-.85.33-2.34 2.37-3.47C10.5 13.1 9.66 13 9 13z"/>
            </svg>
            <span>Faculty</span>
        </a>
        
        <a href="#" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
            </svg>
            <span>Section</span>
        </a>
        
        <a href="#" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
            </svg>
            <span>Schedule</span>
        </a>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
        <!-- Welcome Card -->
        <div class="welcome-card">
            <h1>WELCOME BACK, ADMIN!</h1>
            <div class="semester-info">
                <div>First Semester</div>
                <div>2025-2026</div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Summary Section -->
            <div class="summary-section">
                <h2>Summary</h2>
                
                <div class="summary-card">
                    <div class="summary-number" id="facultyCount">0</div>
                    <div class="summary-label">FACULTY</div>
                    <svg class="summary-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                    </svg>
                    <div class="summary-decoration top-left"></div>
                    <div class="summary-decoration bottom-right"></div>
                </div>

                <div class="summary-card">
                    <div class="summary-number" id="sectionCount">0</div>
                    <div class="summary-label">SECTIONS</div>
                    <svg class="summary-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7zm-4 6h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
                    </svg>
                    <div class="summary-decoration top-left"></div>
                    <div class="summary-decoration bottom-right"></div>
                </div>
            </div>

            <!-- Recent Activity Section -->
            <div class="activity-section">
                <h2>Recent Activity</h2>
                
                <div id="activityContainer">
                    <div class="activity-empty">No recent activity</div>
                </div>
            </div>
        </div>

        <!-- Schedule Section -->
        <div class="schedule-section">
            <h2>Schedule</h2>
            
            <div class="schedule-wrapper">
                <div class="schedule-left">
                    <div class="courses-label">Courses</div>
                    <div class="courses-list" id="coursesList">
                        <div class="courses-empty">No courses scheduled</div>
                    </div>
                </div>

                <div class="schedule-table-container">
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th>MONDAY</th>
                                <th>TUESDAY</th>
                                <th>WEDNESDAY</th>
                                <th>THURSDAY</th>
                                <th>FRIDAY</th>
                                <th>SATURDAY</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                            <!-- Time slots from 7:30 AM to 9:30 PM will be generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Dropdown toggle
        function toggleDropdown() {
            document.getElementById('dropdownMenu').classList.toggle('show');
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.admin-section') && !event.target.closest('.admin-section')) {
                document.getElementById('dropdownMenu').classList.remove('show');
            }
        }

        // Generate time slots from 7:30 AM to 9:30 PM
        function generateTimeSlots() {
            const tbody = document.getElementById('scheduleTableBody');
            tbody.innerHTML = '';
            
            const times = [];
            for (let hour = 7; hour <= 21; hour++) {
                times.push(`${hour}:00`);
                if (hour < 21) {
                    times.push(`${hour}:30`);
                }
            }
            
            times.forEach(time => {
                const row = document.createElement('tr');
                row.className = 'time-row';
                
                for (let day = 0; day < 6; day++) {
                    const td = document.createElement('td');
                    td.setAttribute('data-time', time);
                    td.setAttribute('data-day', day);
                    row.appendChild(td);
                }
                
                tbody.appendChild(row);
            });
        }

        // Load counts from localStorage
        function loadCounts() {
            const faculty = JSON.parse(localStorage.getItem('faculty') || '[]');
            const sections = JSON.parse(localStorage.getItem('sections') || '[]');
            
            document.getElementById('facultyCount').textContent = faculty.length;
            document.getElementById('sectionCount').textContent = sections.length;
        }

        // Load recent activity
        function loadRecentActivity() {
            const activities = JSON.parse(localStorage.getItem('activities') || '[]');
            const container = document.getElementById('activityContainer');
            
            if (activities.length === 0) {
                container.innerHTML = '<div class="activity-empty">No recent activity</div>';
                return;
            }
            
            // Group by date
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            const todayActivities = activities.filter(a => new Date(a.timestamp).toDateString() === today);
            const yesterdayActivities = activities.filter(a => new Date(a.timestamp).toDateString() === yesterday);
            
            let html = '';
            
            if (todayActivities.length > 0) {
                html += '<div class="activity-day"><div class="activity-day-label">Today</div>';
                todayActivities.forEach(activity => {
                    const time = new Date(activity.timestamp).toLocaleString('en-US', {
                        month: '2-digit',
                        day: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                    html += `
                        <div class="activity-item">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                            </svg>
                            <span>${activity.message}</span>
                            <span class="activity-time">${time}</span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            if (yesterdayActivities.length > 0) {
                html += '<div class="activity-day"><div class="activity-day-label">Yesterday</div>';
                yesterdayActivities.forEach(activity => {
                    const time = new Date(activity.timestamp).toLocaleString('en-US', {
                        month: '2-digit',
                        day: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                    html += `
                        <div class="activity-item">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                            </svg>
                            <span>${activity.message}</span>
                            <span class="activity-time">${time}</span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        // Load courses and schedule
        function loadSchedule() {
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const schedules = JSON.parse(localStorage.getItem('schedules') || '[]');
            
            const coursesList = document.getElementById('coursesList');
            
            // Filter courses that have schedules assigned
            const scheduledCourses = courses.filter(course => 
                schedules.some(s => s.courseId === course.id)
            );
            
            if (scheduledCourses.length === 0) {
                coursesList.innerHTML = '<div class="courses-empty">No courses scheduled</div>';
                return;
            }
            
            // Display courses in sidebar
            coursesList.innerHTML = '';
            scheduledCourses.forEach(course => {
                const courseLabel = document.createElement('div');
                courseLabel.className = 'course-label';
                courseLabel.innerHTML = `
                    <div class="course-color" style="background: ${course.color || '#FFA726'};"></div>
                    <span>${course.course_code}</span>
                `;
                coursesList.appendChild(courseLabel);
            });
            
            // Display schedules in table
            schedules.forEach(schedule => {
                const course = courses.find(c => c.id === schedule.courseId);
                if (!course) return;
                
                const section = JSON.parse(localStorage.getItem('sections') || '[]')
                    .find(s => s.id === schedule.sectionId);
                
                // Find the correct cell
                const timeSlots = document.querySelectorAll(`td[data-day="${schedule.day}"][data-time="${schedule.startTime}"]`);
                
                timeSlots.forEach(cell => {
                    const scheduleBlock = document.createElement('div');
                    scheduleBlock.className = 'schedule-block';
                    scheduleBlock.style.background = course.color || '#FFA726';
                    scheduleBlock.innerHTML = `
                        <div class="course-code">${course.course_code}</div>
                        <div class="course-details">Room: ${schedule.room || 'TBA'}</div>
                        <div class="course-details">${section ? section.name : 'No Section'}</div>
                    `;
                    
                    cell.appendChild(scheduleBlock);
                    cell.classList.add('schedule-cell');
                    
                    // Calculate rowspan based on duration
                    if (schedule.duration) {
                        const durationSlots = Math.ceil(schedule.duration / 30);
                        cell.setAttribute('rowspan', durationSlots);
                        
                        // Remove cells that are covered by rowspan
                        let nextRow = cell.parentElement.nextElementSibling;
                        for (let i = 1; i < durationSlots && nextRow; i++) {
                            const cellToRemove = nextRow.querySelector(`td[data-day="${schedule.day}"]`);
                            if (cellToRemove) {
                                cellToRemove.remove();
                            }
                            nextRow = nextRow.nextElementSibling;
                        }
                    }
                });
            });
        }

        // Initialize dashboard
        window.addEventListener('DOMContentLoaded', function() {
            generateTimeSlots();
            loadCounts();
            loadRecentActivity();
            loadSchedule();
        });

        // Listen for storage changes from other tabs
        window.addEventListener('storage', function(e) {
            if (e.key === 'courses' || e.key === 'schedules' || e.key === 'faculty' || 
                e.key === 'sections' || e.key === 'activities') {
                loadCounts();
                loadRecentActivity();
                loadSchedule();
            }
        });
    </script>
</body>
</html>